

- name: installing yum requirements
  yum:
    name: "{{ item }}"
    state: latest
  with_items: 
    - python3
    - python-pip
    - git

- pip:
    name: "{{ item }}"
    executable: pip3
  become: true
  become_user: root
  with_items: 
    - virtualenv
    - Flask

- copy:
    src: /tmp/packer-ansible-provisioner/roles/application/files/pugsite.service
    dest: /etc/systemd/system/pugsite.service
    owner: root
    group: root
    mode: 0644

- name: Create site directory
  ansible.builtin.file:
    path: /pugsite
    state: directory
    owner: root
    group: root
    mode: '0644'

- copy:
    src: /tmp/packer-ansible-provisioner/roles/application/files/pugsite-start.sh
    dest: /pugsite/pugsite-start.sh
    owner: root
    group: root
    mode: 0644

- name: Git checkout
  ansible.builtin.git:
    repo: 'https://github.com/imp14a/python-flask-pugsite.git'
    dest: /pugsite/app

- name: Install requirements
  pip: 
    requirements: /pugsite/app/requirements.txt
    virtualenv: /pugsite/app/venv
    virtualenv_python: python3