

- name: installing yum requirements
  yum:
    name: ['python3','python-pip','git']
    state: latest

- copy:
    src: /tmp/packer-ansible-provisioner/roles/application/files/pugsite.service
    dest: /etc/systemd/system/pugsite.service
    owner: root
    group: root
    mode: 0644

- name: Ensure group "siteadmin" exists
  ansible.builtin.group:
    name: siteadmin
    state: present

- name: Add the user 'siteadmin'
  ansible.builtin.user:
    name: siteadmin
    group: siteadmin

- pip:
    name: ['virtualenv','Flask']
    executable: pip3
    extra_args: --user
  become: true
  become_user: siteadmin


- name: Create site directory
  ansible.builtin.file:
    path: /pugsite
    state: directory
    recurse: true
    owner: siteadmin
    group: siteadmin
    mode: '0644'

- copy:
    src: /tmp/packer-ansible-provisioner/roles/application/files/pugsite-start.sh
    dest: /pugsite/pugsite-start.sh
    owner: siteadmin
    group: siteadmin
    mode: '0644'

- name: Git checkout
  ansible.builtin.git:
    repo: 'https://github.com/imp14a/python-flask-pugsite.git'
    dest: /pugsite/app
  become: true
  become_user: root

- name: Install requirements
  pip: 
    requirements: /pugsite/app/requirements.txt
    virtualenv: /pugsite/app/venv
    virtualenv_python: python3
  tags:
    - venv
  environment:
    PATH: "{{ ansible_env.PATH }}:/usr/local/bin"
  become: true
  become_user: root

- name: Change directory permissions
  ansible.builtin.file:
    path: /pugsite
    state: directory
    recurse: true
    owner: siteadmin
    group: siteadmin
    mode: '0644'